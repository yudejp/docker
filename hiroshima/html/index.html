<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>yude.jp @ 広島県 広島市</title>
    <meta http-equiv="content-type"
        content="text/html; charset=utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Hiroshima, Japan" />
    <style>
        td {
            border: 1px black solid;
            padding: 10px;
        }
    </style>
</head>

<body style="max-width: 500px; margin-left: auto; margin-right: auto">
    <h1>hiroshima.yude.jp</h1>
    <p>このページは、広島県 広島市 に設置された <a href="https://www.yude.jp/profile">yude</a> の自宅サーバーから配信されています。</p>
    <p id="todays_traffic"></p>
    <table rules="all">
        <tr>
            <th>ホスト名</th>
            <th>説明</th>
        </tr>
        <tr>
            <td><a href="https://bluemap.yude.jp">bluemap.yude.jp</a></td>
            <td>BlueMap, Minecraft サーバーの地図</td>
        </tr>
        <tr>
            <td><a href="https://git.yude.jp">git.yude.jp</a></td>
            <td>Gitea, セルフホスト Git リモートサーバー</td>
        </tr>
        <tr>
            <td><a href="https://nc.yude.jp">nc.yude.jp</a></td>
            <td>Nextcloud, セルフホスト クラウド / オフィススイート</td>
        </tr>
        <tr>
            <td><a href="https://files.yude.jp">files.yude.jp</a></td>
            <td>ファイル置き場</td>
        </tr>
        <tr>
            <td><a href="https://prometheus.yude.jp/">prometheus.yude.jp</a></td>
            <td>Prometheus</td>
        </tr>
        <tr>
            <td><a href="https://grafana.yude.jp/">grafana.yude.jp</a></td>
            <td>Grafana</td>
        </tr>
        <tr>
            <td><a href="https://overleaf.yude.jp/">overleaf.yude.jp</a></td>
            <td>Overleaf, オンライン LaTeX エディタ</td>
        </tr>
        <tr>
            <td>非公開</td>
            <td>EpgDataCapBon (EDCB), 録画管理ソフトウェア</td>
        </tr>
        <tr>
            <td>非公開</td>
            <td>BonDriverProxyEx, チューナーのスロットを管理するソフトウェア</td>
        </tr>
        <tr>
            <td>非公開</td>
            <td>KonomiTV, EPGStation / EDCB 対応 DVR 視聴管理インフラストラクチャ</td>
        </tr>
    </table>
    <script async>
        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 バイト'

            const k = 1024
            const dm = decimals < 0 ? 0 : decimals
            const sizes = ['バイト', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']

            const i = Math.floor(Math.log(bytes) / Math.log(k))

            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`
        }

        let now = new Date();

        let traffic_in_hiroshima_from = 'https://prometheus.yude.jp/api/v1/query?query={__name__=~"ifHCInOctets|ifHCOutOctets",instance="192.168.100.1",ifAlias="WAN1"}&time=' + new Date(now.getFullYear(), now.getMonth() + 1, now.getDate(), 0, 0, 0).getTime() / 1000
        let traffic_in_hiroshima_to = 'https://prometheus.yude.jp/api/v1/query?query={__name__=~"ifHCInOctets|ifHCOutOctets",instance="192.168.100.1",ifAlias="WAN1"}&time=' + now.getTime() / 1000;

        fetch(traffic_in_hiroshima_to, { method: 'GET' })
            .then(function (res_to) {
                return res_to.json();
            })
            .then(function (res_json_to) {
                fetch(traffic_in_hiroshima_from, { method: 'GET' })
                    .then(function (res_from) {
                        return res_from.json();
                    })
                    .then(function (res_json_from) {
                        let traffic_hiroshima_from_numeric = 0;
                        let traffic_hiroshima_to_numeric = parseInt(res_json_to["data"]["result"][0]["value"][1]) + parseInt(res_json_to["data"]["result"][1]["value"][1])
                        try {
                            traffic_hiroshima_from_numeric = parseInt(res_json_from["data"]["result"][0]["value"][1]) + parseInt(res_json_from["data"]["result"][1]["value"][1])
                        } catch {}

                        let target_element = document.getElementById("todays_traffic");
                        target_element.innerHTML = "今日の通信量は " + formatBytes(traffic_hiroshima_to_numeric - traffic_hiroshima_from_numeric) + " です。"
                    })
            })
    </script>
</body>

</html>